<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GLB Viewer</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

  <script type="module" src="src/main.ts" defer></script>
  <link href="src/style.css" rel="stylesheet">
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>3D Model Viewer</h1>
      <p>Visualize your GLB models with LOD</p>
    </div>
    <div class="row">
      <div class="col-md-12 text-center">
        <form id="uploadForm" enctype="multipart/form-data">
          <div class="mb-3 text-start">
            <label for="inputFile" class="form-label">Select GLB/GLTF File</label>
            <input type="file" name="file" class="form-control" id="inputFile" required>
          </div>
          <div class="mb-3 text-start">
            <label for="ratio" class="form-label">LOD Ratio</label>
            <input type="number" step="0.01" name="ratio" class="form-control" id="ratio" value="0.08" required>
          </div>
          <div class="mb-3 text-start">
            <label for="error" class="form-label">LOD Error</label>
            <input type="number" step="0.01" name="error" class="form-control" id="error" value="1" required>
          </div>
          <button type="submit" class="btn btn-custom">Upload and Generate LOD</button>
        </form>
      </div>
    </div>
  </div>

  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
  <script>
    let scene, camera, renderer, controls;

    const createLight = (scene, x, y, z) => {
      const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
      directionalLight.position.set(x, y, z);
      scene.add(directionalLight);
    }

    const animate = () => {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }

    const displayModel = (dataUrl) => {
      const gltfLoader = new THREE.GLTFLoader();
      gltfLoader.load(dataUrl, (gltf) => {
        const model = gltf.scene;
        scene.add(model);
        createBoundingBox(model);
        animate();
      });
    }

    let lodModel = null;

    document.querySelector('input[name="file"]').oninput = event => {
      // 初期化
      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
      renderer = new THREE.WebGLRenderer();
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.body.appendChild(renderer.domElement); // TODO: 既存のdomElement削除
      controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.object.position.set(2, 0, 0);
      controls.target.set(2, 0, 0);
      createLight(scene, 5, 10, 7.5);
      createLight(scene, -5, -10, -7.5);
      camera.position.z = 5;

      console.log(event.target.files);
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          displayModel(e.target.result);
        }
        reader.readAsDataURL(file);
      }
    };

    const createBoundingBox = (model) => {
      const box = new THREE.Box3().setFromObject(model);
      const size = new THREE.Vector3();
      box.getSize(size);

      const boxGeometry = new THREE.BoxGeometry(size.x, size.y, size.z);
      const boxMaterial = new THREE.MeshBasicMaterial({
        color: 0x5b4c47,
        opacity: 0.5,
        transparent: true
      });

      const boxMesh = new THREE.Mesh(boxGeometry, boxMaterial);
      boxMesh.position.set(
        (box.min.x + box.max.x) / 2 + 4,
        (box.min.y + box.max.y) / 2,
        (box.min.z + box.max.z) / 2
      );
      scene.add(boxMesh);
    }

    document.getElementById('uploadForm').addEventListener('submit', async function (event) {
      event.preventDefault();
      const formData = new FormData(this);

      try {
        const response = await fetch('/create_lod', {
          method: 'POST',
          body: formData
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const blob = await response.blob();
        const url = URL.createObjectURL(blob);
        loadModels(url);
      } catch (error) {
        console.error('Error:', error);
      }
    });

    const gltfLoader = new THREE.GLTFLoader();

    const loadModels = async (lodPath) => {
      lodModel && scene.remove(lodModel);

      gltfLoader.load(lodPath, (gltf) => {
        lodModel = gltf.scene;
        lodModel.position.x = 2; // Offset to distinguish between original and LOD
        scene.add(lodModel);
        animate();
      });
    }
  </script> -->
</body>

</html>
